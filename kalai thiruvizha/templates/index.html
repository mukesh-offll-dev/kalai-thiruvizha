<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalai Thiruvizha - 25 Registration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Kalai Thiruvizha - 25 Registration</h1>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
         
        <form id="registrationForm" method="POST" action="{{ url_for('register') }}">
            <!-- Participation Type -->
            <div class="form-group">
                <label for="participation_type">Participation Type:</label>
                <select id="participation_type" name="participation_type" required onchange="toggleGroupFields()">
                    <option value="">Select Type</option>
                    <option value="solo">Solo</option>
                    <option value="group">Group</option>
                </select>
            </div>

            <!-- Group Size Field (Hidden by default) -->
            <div class="form-group" id="groupSizeField" style="display: none;">
                <label for="group_size">Number of Students in Group:</label>
                <input type="number" id="group_size" name="group_size" min="2" max="10" onchange="generateGroupFields()">
            </div>

            <!-- Main Participant Details -->
            <div class="form-section">
                <h3>Main Participant Details</h3>
                <div class="form-group">
                    <label for="register_no">Register No:</label>
                    <input type="text" id="register_no" name="register_no" required>
                </div>

                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="year">Year:</label>
                    <select id="year" name="year" required>
                        <option value="">Select Year</option>
                        <option value="1st Year">1st Year</option>
                        <option value="2nd Year">2nd Year</option>
                        <option value="3rd Year">3rd Year</option>
                        <option value="4th Year">4th Year</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="department">Department:</label>
                    <select id="department" name="department" required>
                        <option value="">Select Department</option>
                        <option value="CSE">Computer Science Engineering</option>
                        <option value="ECE">Electronics and Communication Engineering</option>
                        <option value="EEE">Electrical and Electronics Engineering</option>
                        <option value="MECH">Mechanical Engineering</option>
                        <option value="CIVIL">Civil Engineering</option>
                        <option value="IT">Information Technology</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="gender">Gender:</label>
                    <select id="gender" name="gender" required>
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>

            <!-- Group Members Section -->
            <div id="groupMembersSection" style="display: none;">
                <h3>Group Members Details</h3>
                <div id="groupFields"></div>
            </div>

            <!-- Competition Selection -->
            <div class="form-group">
                <label for="competition">Competition:</label>
                <select id="competition" name="competition" required>
                    <option value="">Select Competition</option>
                    <option value="Singing">Singing Competition</option>
                    <option value="Dance">Dance Competition</option>
                    <option value="Drama">Drama Competition</option>
                    <option value="Drawing">Drawing Competition</option>
                    <option value="Photography">Photography Competition</option>
                    <option value="Debate">Debate Competition</option>
                    <option value="Quiz">Quiz Competition</option>
                </select>
            </div>

            <button type="submit" class="btn-submit">Register</button>
        </form>
    </div>

    <script>
        // Add this function to check registration limit in real-time
        function checkRegistrationLimit(registerNo) {
            if (registerNo.length < 3) return; // Minimum 3 characters
            
            fetch(`/check-limit/${registerNo}`)
                .then(response => response.json())
                .then(data => {
                    const registerNoInput = document.getElementById('register_no');
                    const limitInfo = document.getElementById('limitInfo') || createLimitInfoElement();
                    
                    if (data.can_register) {
                        limitInfo.innerHTML = `✅ ${registerNo} can register for ${3 - data.current_count} more competitions`;
                        limitInfo.className = 'alert alert-success';
                        registerNoInput.style.borderColor = '#059669';
                    } else {
                        limitInfo.innerHTML = `❌ ${data.message}`;
                        limitInfo.className = 'alert alert-error';
                        registerNoInput.style.borderColor = '#dc2626';
                    }
                })
                .catch(error => {
                    console.error('Error checking registration limit:', error);
                });
        }

        function createLimitInfoElement() {
            const limitInfo = document.createElement('div');
            limitInfo.id = 'limitInfo';
            const registerNoGroup = document.getElementById('register_no').closest('.form-group');
            registerNoGroup.appendChild(limitInfo);
            return limitInfo;
        }

        // Add event listener for register_no input
        document.addEventListener('DOMContentLoaded', function() {
            const registerNoInput = document.getElementById('register_no');
            if (registerNoInput) {
                registerNoInput.addEventListener('blur', function() {
                    checkRegistrationLimit(this.value.trim());
                });
                
                registerNoInput.addEventListener('input', function() {
                    // Clear the limit info when user starts typing again
                    const limitInfo = document.getElementById('limitInfo');
                    if (limitInfo) {
                        limitInfo.innerHTML = '';
                        limitInfo.className = '';
                    }
                    this.style.borderColor = '#e2e8f0';
                });
            }
            
            // Also check group members when they lose focus
            document.addEventListener('blur', function(e) {
                if (e.target.name && e.target.name.startsWith('register_no_')) {
                    checkRegistrationLimit(e.target.value.trim());
                }
            }, true);
        });
        function toggleGroupFields() {
            const participationType = document.getElementById('participation_type').value;
            const groupSizeField = document.getElementById('groupSizeField');
            const groupMembersSection = document.getElementById('groupMembersSection');
            
            if (participationType === 'group') {
                groupSizeField.style.display = 'block';
                groupMembersSection.style.display = 'block';
            } else {
                groupSizeField.style.display = 'none';
                groupMembersSection.style.display = 'none';
                document.getElementById('groupFields').innerHTML = '';
            }
        }

        function generateGroupFields() {
            const groupSize = parseInt(document.getElementById('group_size').value);
            const groupFields = document.getElementById('groupFields');
            groupFields.innerHTML = '';
            
            if (groupSize > 1) {
                for (let i = 1; i < groupSize; i++) {
                    const memberDiv = document.createElement('div');
                    memberDiv.className = 'member-form';
                    memberDiv.innerHTML = `
                        <h4>Member ${i}</h4>
                        <div class="form-group">
                            <label>Register No:</label>
                            <input type="text" name="register_no_${i}" required>
                        </div>
                        <div class="form-group">
                            <label>Name:</label>
                            <input type="text" name="name_${i}" required>
                        </div>
                        <div class="form-group">
                            <label>Year:</label>
                            <select name="year_${i}" required>
                                <option value="">Select Year</option>
                                <option value="1st Year">1st Year</option>
                                <option value="2nd Year">2nd Year</option>
                                <option value="3rd Year">3rd Year</option>
                                <option value="4th Year">4th Year</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Department:</label>
                            <select name="dept_${i}" required>
                                <option value="">Select Department</option>
                                <option value="CSE">Computer Science Engineering</option>
                                <option value="ECE">Electronics and Communication Engineering</option>
                                <option value="EEE">Electrical and Electronics Engineering</option>
                                <option value="MECH">Mechanical Engineering</option>
                                <option value="CIVIL">Civil Engineering</option>
                                <option value="IT">Information Technology</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Gender:</label>
                            <select name="gender_${i}" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <hr>
                    `;
                    groupFields.appendChild(memberDiv);
                }
            }
        }
    </script>
</body>
</html>